<!-- Case Study List Module -->

{#
  CSS ORGANIZATION:
  - Layout styles (container, grid, widths, responsive) = HERE in scoped CSS (dynamic module values)
  - Component styles (colors, padding, borders, hover) = module.css (static styles)
#}

{# Scoped CSS for layout styles #}
<style>
  {% scope_css %}
    {# Container base layout - applies to all layouts #}
    .case-study-list__container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: var(--gap);
      justify-content: center;
    }

    {# Basic Grid Layout #}
    {% if module.layout.layout == 'basic-grid' %}
      .basic-grid .case-study-list__item {
        width: calc(100% / {{module.layout.columns}} - (var(--gap) * ({{module.layout.columns}} - 1) / {{module.layout.columns}}));
      }
      
      @media (max-width: 991.98px) {
        .basic-grid .case-study-list__item {
          width: calc(50% - (var(--gap) / 2));
        }
      }
      
      @media (max-width: 700px) {
        .basic-grid .case-study-list__item {
          width: 100%;
        }
      }
    {% endif %}

    {# Mosaic Grid Layout #}
    {% if module.layout.layout == 'mosaic-grid' %}
      {% set mosaic_big_element_height = module.layout.height %}
      {% set mosaic_small_element_height = (module.layout.height / 2) - 10 %}
      
      .mosaic-grid .case-study-list__container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--gap);
      }
      
      .mosaic-grid .case-study-list__item {
        width: 100%;
        height: {{mosaic_small_element_height|int}}px;
      }
      
      .mosaic-grid .case-study-list__item:first-child {
        grid-column: span 2;
        grid-row: span 2;
        height: {{mosaic_big_element_height}}px;
      }
      
      .mosaic-grid .case-study-list__item-image {
        height: 100%;
        width: 100%;
        object-fit: cover;
      }
      
      @media (max-width: 991.98px) {
        .mosaic-grid .case-study-list__item:first-child {
          grid-column: span 1;
          grid-row: span 1;
          height: {{mosaic_small_element_height|int}}px;
        }
      }
    {% endif %}
  {% end_scope_css %}
</style>

{# MODE BRANCHING: Related vs Standard #}
{% if module.content.mode == 'related' %}
  
  {# RELATED MODE: Show case studies from same industry, excluding current case #}
  {% set limited_case_studies = [] %}
  {% set industries = [] %}
  {% set base_slug = content.slug %}
  {% set show_filter_dropdown = false %}
  
  {% if dynamic_page_hubdb_row and dynamic_page_hubdb_row.summary_industry %}
    {% set current_industry = dynamic_page_hubdb_row.summary_industry %}
    {% set current_row_id = dynamic_page_hubdb_row.hs_id %}
    {% set related_cases = hubdb_table_rows('case_study', "summary_industry=" ~ current_industry.name) %}
    
    {# Filter: exclude current case study and hidden ones, limit to 3 #}
    {% for case in related_cases %}
      {% if case.hs_id != current_row_id and not case.hide %}
        {% do limited_case_studies.append(case) %}
        {% if limited_case_studies|length >= 3 %}
          {% break %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}
  
{% else %}
  
  {# STANDARD MODE: Original configurable list #}
  {# Fetch all case studies from HubDB #}
  {% set all_case_studies = hubdb_table_rows('case_study') %}
    
  {# Filter out hidden case studies #}
  {% set visible_case_studies = [] %}
  {% for case in all_case_studies %}
    {% if not case.hide %}
      {% do visible_case_studies.append(case) %}
    {% endif %}
  {% endfor %}
  
  {# Extract unique industries for filter dropdown #}
  {% set industries = [] %}
  {% for case in visible_case_studies %}
    {% if case.summary_industry and case.summary_industry.name not in industries %}
      {% do industries.append(case.summary_industry.name) %}
    {% endif %}
  {% endfor %}
  
  {# Limit to the configured number of articles #}
  {% set limited_case_studies = visible_case_studies[:module.content.number_of_articles] %}
  
  {# Set base slug for case study detail pages #}
  {% if module.content.detail_page.url.content_id %}
    {% set selected_page = content_by_id(module.content.detail_page.url.content_id) %}
    {% set base_slug = selected_page.slug if selected_page else content.slug %}
  {% elif module.content.detail_page.url.href %}
    {% set base_slug = module.content.detail_page.url.href|replace('/', '', 1) if module.content.detail_page.url.href.startswith('/') else module.content.detail_page.url.href %}
  {% else %}
    {% set base_slug = content.slug %}
  {% endif %}
  
  {# Show filter if enabled and multiple industries exist #}
  {% set show_filter_dropdown = module.content.show_filter and industries|length > 1 %}
  
{% endif %}

{# Display case studies #}
{% if limited_case_studies|length > 0 %}
  <div class="case-study-list-module {{ module.layout.layout }}">
    
    {# Industry Filter Dropdown - only in standard mode with multiple industries #}
    {% if show_filter_dropdown %}
      <div class="case-study-list__filter-wrapper">
        <label for="case-study-industry-filter" class="case-study-list__filter-label">Filter by Industry:</label>
        <select id="case-study-industry-filter" class="case-study-list__filter-dropdown">
          <option value="all">All Industries</option>
          {% for industry in industries %}
            <option value="{{ industry }}">{{ industry|replace('_', ' ')|title }}</option>
          {% endfor %}
        </select>
      </div>
    {% endif %}
    
    <div class="case-study-list__container">
      {% for case in limited_case_studies %}
        <a href="{{ '/' ~ base_slug ~ '/' ~ case.hs_path }}" 
           class="case-study-list__item" 
           data-industry="{{ case.summary_industry.name if case.summary_industry else 'none' }}">
          
        {% if case.summary_featured_image %}
            <img class="case-study-list__item-image"
              src="{{case.summary_featured_image.url}}"
              alt="{{case.summary_featured_image.altText}}"
              width="{{case.summary_featured_image.width}}"
              height="{{case.summary_featured_image.height}}"
              srcset="{{ resize_image_url(case.summary_featured_image.url, 0, 0, 500) }}">
          {% endif %}
          
          {% if case.summary_industry %}
            <span class="case-study-list__item-industry">{{ case.summary_industry.label }}</span>
          {% endif %}
          
          {% if case.title %}
            <h3 class="case-study-list__item-title">{{ case.title }}</h3>
          {% endif %}
          
        </a>
      {% endfor %}
    </div>
  </div>
{% else %}
  <div class="case-study-list-module">
    <p>No case studies found.</p>
  </div>
{% endif %}
